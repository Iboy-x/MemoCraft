<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/icon.png">
    <title>Memory Craft</title>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1Q6rt_NwIcTYgZZWqne7srnq3E3ZJVVU",
            authDomain: "memorycraft-cba14.firebaseapp.com",
            projectId: "memorycraft-cba14",
            storageBucket: "memorycraft-cba14.firebasestorage.app",
            messagingSenderId: "853110747298",
            appId: "1:853110747298:web:35507c8a932f1835a267fb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services available globally
        window.auth = auth;
        window.db = db;
        window.serverTimestamp = serverTimestamp;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getDocs = getDocs;

        // Set up anonymous authentication
        signInAnonymously(auth)
            .then(() => {
                console.log("User signed in anonymously");
                window.fetchLeaderboard("easy"); // Initial leaderboard load
            })
            .catch((error) => {
                console.error("Authentication error:", error);
            });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pixelify+Sans&display=swap');

        :root {
            --bg-color: #1e1e1e;
            --text-color: #cfcfcf;
            --card-color: #497c43;
            --card-flipped-color: #6faf5f;
            --card-flipped-text-color: #111;
            --matched-glow: 0 0 15px #3aff3a;
        }

        [data-theme="dark"] {
            --bg-color: #2b2d2f;
            --text-color: #d4d4d4;
            --card-color: #3c6e47;
            --card-flipped-color: #5cdb95;
            --card-flipped-text-color: #000;
            --matched-glow: 0 0 15px #43eb1d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-image: url('images/minecraft_bg.jpg');
            background-size: cover;
            background-attachment: fixed;  
            overflow-x: hidden;           
            overflow-y: auto;          
            font-family: 'Pixelify Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-text {
            color: #43eb1d;
            font-size: 2rem;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #43eb1d;
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-progress {
            width: 200px;
            height: 20px;
            background: rgba(67, 235, 29, 0.2);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: #43eb1d;
            transition: width 0.3s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        a {
            color: #43eb1d;
            text-decoration: none;
        }

        h1 {
            color: #43eb1d;
            font-size: clamp(2rem, 5vw, 3rem);
            text-align: center;
            margin: 10px 0;
            animation: floatAnimation 3s ease-in-out infinite;
        }

        .score-board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
        }

        .theme-toggle {
            margin: 10px;
            font-size: clamp(0.8rem, 2vw, 1rem);
            cursor: pointer;
            background-color: var(--card-color);
            color: var(--card-flipped-color);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            position: fixed;
            top: 10px;
            right: 10px;
        }

        .difficulty-controls {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .difficulty-btn {
            background-color: var(--card-color);
            color: var(--card-flipped-color);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        .difficulty-btn.active {
            background-color: var(--card-flipped-color);
            color: var(--card-color);
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 8px;
            width: 95%;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            width: 100%;
            aspect-ratio: 1;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.4s ease;
            cursor: pointer;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: white;
            border-radius: 8px;
            background-color: var(--card-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        .card-back {
            transform: rotateY(180deg);
            background-color: var(--card-flipped-color);
            background-size: 80% 80%;
            background-repeat: no-repeat;
            background-position: center;
        }

        .card:hover .card-front {
            background-color: #5a9654;
        }

        .card.matched .card-back {
            animation: matchedCard 0.4s ease-out forwards;
            box-shadow: var(--matched-glow);
        }

        .card.wrong {
            animation: wrongCard 0.4s ease-out;
        }

        @keyframes matchedCard {
            0% {
                transform: rotateY(180deg) scale(1);
            }
            50% {
                transform: rotateY(180deg) scale(1.1);
            }
            100% {
                transform: rotateY(180deg) scale(1);
            }
        }

        @keyframes wrongCard {
            0%, 100% {
                transform: rotateY(180deg) translateX(0);
            }
            33% {
                transform: rotateY(180deg) translateX(-5px);
            }
            66% {
                transform: rotateY(180deg) translateX(5px);
            }
        }

        /* Remove unnecessary pseudo-elements */
        .card-content {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transform-style: preserve-3d;
        }

        @keyframes floatAnimation {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .footer {
            margin: 20px 0;
            font-size: clamp(0.8rem, 2vw, 1rem);
            text-align: center;
        }

        .audio-controls {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .audio-controls button {
            background-color: var(--card-color);
            color: var(--card-flipped-color);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 1rem);
            transition: all 0.3s ease;
        }

        .audio-controls button:hover {
            background-color: var(--card-flipped-color);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
            color: white;
        }

        .audio-controls button:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal h2 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin-bottom: 15px;
            color: #43eb1d;
        }

        .modal .score-message {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(67, 235, 29, 0.1);
            color: #43eb1d;
        }

        .modal .score-message.not-top {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .modal p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            margin: 10px 0;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 999;
        }

        .modal button {
            background-color: var(--card-color);
            color: var(--card-flipped-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            margin-top: 15px;
        }

        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 5px;
            }

            .score-board {
                font-size: 0.9rem;
                padding: 8px;
            }

            .theme-toggle {
                padding: 6px 12px;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) {
            .game-board {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
        }

        @keyframes scorePopup {
            0% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.5);
                opacity: 0.7;
            }
            100% { 
                transform: scale(1);
                opacity: 0;
            }
        }

        .score-popup {
            position: fixed;
            color: #43eb1d;
            font-size: 1.5rem;
            pointer-events: none;
            animation: scorePopup 1s ease-out forwards;
            z-index: 1000;
        }

        /* Remove Google Sheets related styles */
        .leaderboard {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            width: 90%;
            max-width: 600px;
        }

        .leaderboard h2 {
            color: #43eb1d;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(67, 235, 29, 0.3);
        }

        .leaderboard-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            background: var(--card-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Pixelify Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #43eb1d;
            color: #000;
        }

        .leaderboard-entry {
            display: grid;
            grid-template-columns: 0.5fr 2fr 1fr 1fr;
            padding: 8px;
            margin: 5px 0;
            background: rgba(67, 235, 29, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
            transition: transform 0.2s ease;
        }

        .leaderboard-entry:nth-child(even) {
            background: rgba(67, 235, 29, 0.05);
        }

        .leaderboard-entry .rank {
            color: #43eb1d;
        }

        .leaderboard-entry .name {
            color: #fff;
        }

        .leaderboard-entry .score {
            color: #43eb1d;
            text-align: right;
        }

        .leaderboard-entry .time {
            color: #fff;
            text-align: right;
        }

        .leaderboard-entry:hover {
            transform: scale(1.02);
            background: rgba(67, 235, 29, 0.2);
        }

        .no-scores {
            text-align: center;
            color: #43eb1d;
            padding: 10px;
        }

        /* Add loading style */
        .loading {
            text-align: center;
            color: #43eb1d;
            padding: 10px;
            animation: pulse 1.5s infinite;
        }

        /* Add modal animations */
        @keyframes modalSlideIn {
            from {
                transform: translate(-50%, -70%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        /* Update button hover animations */
        .difficulty-btn:hover, .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 235, 29, 0.3);
        }

        .theme-toggle:hover {
            animation: glowPulse 1.5s infinite;
        }

        /* Improved victory animations */
        @keyframes celebrate {
            0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.9; }
            40% { transform: translate(-50%, -50%) scale(0.95); opacity: 1; }
            60% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes confetti {
            0% { 
                transform: translateY(-10px) rotateZ(0); 
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% { 
                transform: translateY(1000px) rotateZ(720deg); 
                opacity: 0;
            }
        }

        @keyframes gameComplete {
            0% { 
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
                filter: blur(20px);
            }
            40% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
                filter: blur(0px);
            }
            60% { 
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 1;
            }
            80% { 
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .celebration-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 998;
            pointer-events: none;
            perspective: 1000px;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .celebration-overlay.active {
            opacity: 1;
        }

        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #43eb1d;
            clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
            animation: confetti 2.5s ease-out forwards;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .victory-text {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(3);
            font-size: 5rem;
            color: #43eb1d;
            text-shadow: 0 0 30px rgba(67, 235, 29, 0.7),
                         0 0 60px rgba(67, 235, 29, 0.4);
            z-index: 999;
            animation: gameComplete 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
            white-space: nowrap;
            opacity: 0;
            will-change: transform, opacity;
        }

        .modal.game-complete {
            animation: celebrate 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            transform-origin: center center;
        }

        .modal-overlay {
            transition: opacity 0.5s ease-out;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-text">Loading Memory Craft...</div>
        <div class="loading-spinner"></div>
        <div class="loading-progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>

    <!-- Rest of the HTML remains the same -->
    <h1>Memory Craft</h1>
    <button class="theme-toggle" id="theme-toggle">Toggle Theme</button>
    <div class="difficulty-controls">
        <button class="difficulty-btn active" data-difficulty="easy">Easy</button>
        <button class="difficulty-btn" data-difficulty="medium">Medium</button>
        <button class="difficulty-btn" data-difficulty="hard">Hard</button>
    </div>
    <div class="score-board">
        <div>Score: <span id="score">0</span></div>
        <div>Moves: <span id="move-counter">0</span></div>
        <div>Quick Time: <span id="quick-time">0</span>s</div>
    </div>
    <div class="score-board">
        <div id="high-score-container">
            <span id="high-score-label">High Score Easy: </span>
            <span id="high-score">0</span>
        </div>
        <div id="best-time-container">
            <span id="best-time-label">Best Time Easy: </span>
            <span id="best-time">--</span>s
        </div>
    </div>
    <div class="game-board" id="game-board"></div>
    <div class="audio-controls">
        <button id="play-music">Play Music</button>
        <button id="pause-music">Pause Music</button>
    </div>
   

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal" id="game-over-modal">
        <h2>Game Over!</h2>
        <p>Final Score: <span id="final-score"></span></p>
        <p>Time: <span id="final-time"></span>s</p>
        <p>High Score: <span id="modal-high-score"></span></p>
        <div class="score-message" id="score-message"></div>
        <button id="restart-game">Play Again</button>
    </div>

    <div class="leaderboard">
        <h2>Global Leaderboard</h2>
        <div class="leaderboard-tabs">
            <button class="tab-btn active" data-difficulty="easy">Easy</button>
            <button class="tab-btn" data-difficulty="medium">Medium</button>
            <button class="tab-btn" data-difficulty="hard">Hard</button>
        </div>
        <div id="leaderboard-entries"></div>
    </div>

    <div class="footer">Made with ‚ù§Ô∏è by <a href="https://github.com/iboy-x" target="_blank">iboy-x</a></div>
    
    <audio id="bg-music" loop autoplay>
        <source src="minecraftSound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <audio id="flip-sound" preload="auto">
        <source src="images/cards.wav" type="audio/mpeg">
    </audio>
    <audio id="match-sound" preload="auto">
        <source src="images/match.wav" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="images/wrong.mp3" type="audio/mpeg">
    </audio>
    <script>
        // Preload images
        const minecraftItems = [
            'images/pickaxe.png',
            'images/sword.png', 
            'images/diamond.png',
            'images/gold_ingot.png',
            'images/iron_ingot.png',
            'images/redstone.png',
            'images/emerald.png',
            'images/craftingTable.png',
            'images/apple.png',
            'images/bread.png',
            'images/chest.png',
            'images/tnt.png'
        ];

        // Preload all images before starting game
        function preloadImages(callback) {
            let loadedImages = 0;
            const totalImages = minecraftItems.length;
            const progressBar = document.getElementById('progress-bar');
            
            minecraftItems.forEach(src => {
                const img = new Image();
                img.onload = () => {
                    loadedImages++;
                    // Update progress bar
                    const progress = (loadedImages / totalImages) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    if(loadedImages === totalImages) {
                        // Hide loading overlay with a fade effect
                        setTimeout(() => {
                            document.getElementById('loading-overlay').style.opacity = '0';
                            document.getElementById('loading-overlay').style.transition = 'opacity 0.5s ease';
                            setTimeout(() => {
                                document.getElementById('loading-overlay').style.display = 'none';
                            }, 500);
                            callback();
                        }, 500); // Add a small delay to show 100% progress
                    }
                };
                img.src = src;
            });
        }

        const difficultySettings = {
            easy: { pairs: 8, flipTime: 700 },
            medium: { pairs: 10, flipTime: 500 },
            hard: { pairs: 12, flipTime: 300 }
        };

        let currentDifficulty = 'easy';
        let flipTime = difficultySettings.easy.flipTime;

        const gameBoard = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const highScoreLabel = document.getElementById('high-score-label');
        const themeToggle = document.getElementById('theme-toggle');
        const quickTimeElement = document.getElementById('quick-time');
        const bestTimeLabel = document.getElementById('best-time-label');
        const bestTimeElement = document.getElementById('best-time');
        const moveCounterElement = document.getElementById('move-counter');
        const bgMusic = document.getElementById('bg-music');
        const playMusicButton = document.getElementById('play-music');
        const pauseMusicButton = document.getElementById('pause-music');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const modal = document.getElementById('game-over-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const restartButton = document.getElementById('restart-game');

        let highScoreEasy = localStorage.getItem('highScoreEasy') || 0;
        let highScoreMedium = localStorage.getItem('highScoreMedium') || 0;
        let highScoreHard = localStorage.getItem('highScoreHard') || 0;
        let bestTimeEasy = localStorage.getItem('bestTimeEasy') || null;
        let bestTimeMedium = localStorage.getItem('bestTimeMedium') || null;
        let bestTimeHard = localStorage.getItem('bestTimeHard') || null;

        function updateHighScoreDisplay() {
            highScoreLabel.textContent = `High Score ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}: `;
            let currentHighScore;
            switch(currentDifficulty) {
                case 'easy':
                    currentHighScore = highScoreEasy;
                    break;
                case 'medium':
                    currentHighScore = highScoreMedium;
                    break;
                case 'hard':
                    currentHighScore = highScoreHard;
                    break;
            }
            highScoreElement.textContent = currentHighScore;
        }
        
        function updateBestTimeDisplay() {
            bestTimeLabel.textContent = `Best Time ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}: `;
            let currentBestTime;
            switch(currentDifficulty) {
                case 'easy':
                    currentBestTime = bestTimeEasy;
                    break;
                case 'medium':
                    currentBestTime = bestTimeMedium;
                    break;
                case 'hard':
                    currentBestTime = bestTimeHard;
                    break;
            }
            bestTimeElement.textContent = currentBestTime ? currentBestTime : '--';
        }

        updateHighScoreDisplay();
        updateBestTimeDisplay();

        let itemPairs = [];
        let flippedCards = [];
        let matchedCount = 0;
        let score = 0;
        let moves = 0;
        let startTime = null;
        let timerInterval;

        async function checkHighScore(score, difficulty) {
            try {
                const scoresQuery = query(
                    collection(db, "scores"),
                    where("difficulty", "==", difficulty),
                    orderBy("score", "desc"),
                    limit(10)
                );

                const snapshot = await getDocs(scoresQuery);
                const scores = snapshot.docs.map(doc => doc.data());

                // If we have less than 10 scores, any score qualifies
                if (scores.length < 10) return true;

                // Check if the new score is higher than the lowest score in top 10
                const lowestScore = scores[scores.length - 1].score;
                return score > lowestScore;
            } catch (error) {
                console.error("Error checking high score:", error);
                return true; // In case of error, let's give the player a chance to submit
            }
        }

        async function showGameOverModal(finalScore, totalTime) {
            // Start celebration effect
            createConfetti();
            
            // Show modal with improved timing
            setTimeout(() => {
                modal.classList.add('game-complete');
                modal.style.display = 'block';
                modalOverlay.style.display = 'block';
                modalOverlay.style.opacity = '0';
                
                // Fade in overlay smoothly
                requestAnimationFrame(() => {
                    modalOverlay.style.opacity = '1';
                });
            }, 2000); // Delay modal to let victory animation play

            // Update modal content
            document.getElementById('final-score').textContent = finalScore;
            document.getElementById('final-time').textContent = totalTime;
            
            let currentHighScore;
            switch(currentDifficulty) {
                case 'easy':
                    currentHighScore = highScoreEasy;
                    break;
                case 'medium':
                    currentHighScore = highScoreMedium;
                    break;
                case 'hard':
                    currentHighScore = highScoreHard;
                    break;
            }
            document.getElementById('modal-high-score').textContent = currentHighScore;

            // Check if score qualifies for leaderboard
            const isHighScore = await checkHighScore(finalScore, currentDifficulty);
            const scoreMessage = document.getElementById('score-message');
            
            if (isHighScore) {
                // Delay the prompt to not interrupt animations
                scoreMessage.classList.remove('not-top');
                scoreMessage.textContent = "üèÜ Congratulations! You made it to the top 10!";
                setTimeout(() => {
                    const playerName = prompt("Enter your name for the leaderboard (max 15 characters):");
                    if (playerName) {
                        submitScore(playerName, finalScore, totalTime, currentDifficulty);
                    }
                }, 2500);
            } else {
                console.log("Score not high enough for leaderboard");
                scoreMessage.classList.add('not-top');
                scoreMessage.textContent = `Keep practicing! You need a higher score to reach the top 10 in ${currentDifficulty} mode. Try again! üéÆ`;
                fetchLeaderboard(currentDifficulty);
            }
        }

        restartButton.addEventListener('click', () => {
            modal.classList.remove('game-complete');
            modal.style.display = 'none';
            modalOverlay.style.display = 'none';
            resetGame();
        });

        function initializeGame() {
            const numPairs = difficultySettings[currentDifficulty].pairs;
            const selectedItems = minecraftItems.slice(0, numPairs);
            itemPairs = [...selectedItems, ...selectedItems];
            itemPairs.sort(() => Math.random() - 0.5);

            // Responsive grid columns based on screen size and difficulty
            const columns = window.innerWidth < 480 ? 
                (currentDifficulty === 'easy' ? 3 : currentDifficulty === 'medium' ? 4 : 4) :
                (currentDifficulty === 'easy' ? 4 : currentDifficulty === 'medium' ? 5 : 6);
                
            gameBoard.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }

        // Add resize event listener to handle orientation changes
        window.addEventListener('resize', () => {
            initializeGame();
        });

        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                difficultyButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentDifficulty = button.dataset.difficulty;
                flipTime = difficultySettings[currentDifficulty].flipTime;
                updateHighScoreDisplay();
                updateBestTimeDisplay();
                resetGame();
            });
        });

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            timerInterval = setInterval(() => {
                if (startTime && matchedCount < itemPairs.length) {
                    const currentTime = Math.floor((Date.now() - startTime) / 1000);
                    quickTimeElement.textContent = currentTime;
                }
            }, 1000);
        }

        function handleCardClick(card) {
            if (card.classList.contains('flipped') || flippedCards.length === 2) return;

            // Play flip sound
            flipSound.currentTime = 0;
            flipSound.play().catch(e => console.log('Audio play failed:', e));

            if (!startTime) {
                startTime = Date.now();
                startTimer();
            }

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                moves++;
                moveCounterElement.textContent = moves;
                checkForMatch();
            }
        }

        function calculateScore(matches, moves, time) {
            const difficultyMultiplier = {
                easy: 1,
                medium: 1.5,
                hard: 2
            };
            return Math.max(0, Math.floor((matches * 100 / moves) * difficultyMultiplier[currentDifficulty] - (time / 5)));
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const oldScore = score;

            if (card1.dataset.item === card2.dataset.item) {
                matchSound.currentTime = 0;
                matchSound.play().catch(e => console.log('Audio play failed:', e));

                card1.classList.add('matched');
                card2.classList.add('matched');

                matchedCount += 2;
                score = calculateScore(matchedCount / 2, moves, Math.floor((Date.now() - startTime) / 1000));
                
                const scoreDiff = score - oldScore;
                const rect = card1.getBoundingClientRect();
                createScorePopup(rect.left + rect.width / 2, rect.top, scoreDiff);

                scoreElement.textContent = score;

                if (matchedCount === itemPairs.length) {
                    const totalTime = Math.floor((Date.now() - startTime) / 1000);
                    clearInterval(timerInterval);
                    setTimeout(() => showGameOverModal(score, totalTime), 500);
                }

                flippedCards = [];
            } else {
                wrongSound.currentTime = 0;
                wrongSound.play().catch(e => console.log('Audio play failed:', e));

                card1.classList.add('wrong');
                card2.classList.add('wrong');

                setTimeout(() => {
                    card1.classList.remove('flipped', 'wrong');
                    card2.classList.remove('flipped', 'wrong');
                    flippedCards = [];
                }, flipTime * 0.7); // Reduced flip time for wrong matches
            }
        }

        themeToggle.addEventListener('click', () => {
            const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = theme;
        });

        playMusicButton.addEventListener('click', () => bgMusic.play());
        pauseMusicButton.addEventListener('click', () => bgMusic.pause());

        function resetGame() {
            gameBoard.innerHTML = '';
            flippedCards = [];
            matchedCount = 0;
            moves = 0;
            startTime = null;
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            quickTimeElement.textContent = 0;
            moveCounterElement.textContent = 0;
            scoreElement.textContent = 0;

            initializeGame();

            itemPairs.forEach((item, index) => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.item = item;
                card.dataset.index = index;

                // Create card content container
                const cardContent = document.createElement('div');
                cardContent.classList.add('card-content');

                // Create front face
                const cardFront = document.createElement('div');
                cardFront.classList.add('card-front');
                cardFront.textContent = '?';

                // Create back face
                const cardBack = document.createElement('div');
                cardBack.classList.add('card-back');
                cardBack.style.backgroundImage = `url(${item})`;
                cardBack.style.backgroundSize = 'cover';
                cardBack.style.backgroundPosition = 'center';

                // Assemble card
                cardContent.appendChild(cardFront);
                cardContent.appendChild(cardBack);
                card.appendChild(cardContent);

                card.addEventListener('click', () => handleCardClick(card));
                gameBoard.appendChild(card);
            });
        }

        const flipSound = document.getElementById('flip-sound');
        const matchSound = document.getElementById('match-sound');
        const wrongSound = document.getElementById('wrong-sound');

        // Add function to create score popup animation
        function createScorePopup(x, y, points) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = `+${points}`;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            document.body.appendChild(popup);

            // Remove the element after animation
            popup.addEventListener('animationend', () => {
                document.body.removeChild(popup);
            });
        }

        // Start game only after images are preloaded
        preloadImages(() => {
            initializeGame();
            resetGame();
        });

        // Firebase score submission
        async function submitScore(name, score, time, difficulty) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error("User not authenticated");
                    return;
                }

                const scoreData = {
                    name: name.substring(0, 15),
                    score: Number(score),
                    time: Number(time),
                    difficulty: difficulty,
                    timestamp: serverTimestamp()
                };

                await addDoc(collection(db, "scores"), scoreData);
                console.log("Score submitted successfully");
                fetchLeaderboard(difficulty); // Refresh leaderboard after submission
            } catch (error) {
                console.error("Error submitting score:", error);
            }
        }

        // Fetch and display leaderboard
        async function fetchLeaderboard(difficulty) {
            const leaderboardDiv = document.getElementById("leaderboard-entries");
            leaderboardDiv.innerHTML = '<div class="loading">Loading scores...</div>';
            
            try {
                const scoresQuery = query(
                    collection(db, "scores"),
                    where("difficulty", "==", difficulty),
                    orderBy("score", "desc"),
                    limit(10)
                );

                const snapshot = await getDocs(scoresQuery);
                const leaderboardEntries = snapshot.docs.map(doc => doc.data());
                displayLeaderboard(leaderboardEntries);
            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                if (error.code === 'failed-precondition') {
                    // This is the error code when index is not created
                    leaderboardDiv.innerHTML = 
                        '<div class="no-scores">Leaderboard is being set up. Please try again in a few minutes.</div>';
                } else {
                    leaderboardDiv.innerHTML = 
                        '<div class="no-scores">Error loading leaderboard. Please try again later.</div>';
                }
            }
        }

        // Display leaderboard entries
        function displayLeaderboard(entries) {
            const leaderboardDiv = document.getElementById("leaderboard-entries");
            if (!entries || entries.length === 0) {
                leaderboardDiv.innerHTML = '<div class="no-scores">No scores yet! Be the first!</div>';
                return;
            }

            leaderboardDiv.innerHTML = entries
                .map((entry, index) => `
                    <div class="leaderboard-entry">
                        <span class="rank">#${index + 1}</span>
                        <span class="name">${entry.name || 'Anonymous'}</span>
                        <span class="score">${entry.score} pts</span>
                        <span class="time">${entry.time}s</span>
                    </div>
                `)
                .join("");
        }

        // Add leaderboard tab functionality
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                fetchLeaderboard(btn.dataset.difficulty);
            });
        });

        // Initial leaderboard load
        fetchLeaderboard("easy");

        // Update background image path
        document.body.style.backgroundImage = 'url("./images/minecraft_bg.jpg")';

        // Enhanced celebration function
        function createConfetti() {
            const overlay = document.getElementById('celebration-overlay');
            const victoryText = document.getElementById('victory-text');
            
            overlay.style.display = 'block';
            overlay.innerHTML = '';
            
            // Trigger reflow for smooth animation
            void overlay.offsetWidth;
            overlay.classList.add('active');

            // Create multiple confetti pieces with improved variety
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                // Randomize confetti properties
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 0.8 + 's';
                confetti.style.animationDuration = (Math.random() * 0.5 + 2) + 's';
                
                // More varied colors including Minecraft theme
                const colors = ['#43eb1d', '#5cdb95', '#ffeb3b', '#ff5722', '#2ecc71', '#f1c40f'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // Randomize size
                const size = Math.random() * 8 + 10;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                
                // Add 3D rotation with more natural movement
                confetti.style.transform = `
                    rotateX(${Math.random() * 360}deg) 
                    rotateY(${Math.random() * 360}deg)
                    rotate(${Math.random() * 360}deg)
                    translateZ(${Math.random() * 100}px)
                `;
                
                overlay.appendChild(confetti);
            }

            // Show victory text with improved timing
            setTimeout(() => {
                victoryText.style.display = 'block';
                victoryText.style.opacity = '1';
            }, 300);

            // Clean up animations with smoother transitions
            setTimeout(() => {
                victoryText.style.transition = 'opacity 0.8s ease-out';
                overlay.style.transition = 'opacity 0.8s ease-out';
                victoryText.style.opacity = '0';
                overlay.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    victoryText.style.display = 'none';
                    overlay.classList.remove('active');
                    // Reset styles
                    overlay.style.opacity = '';
                    victoryText.style.opacity = '';
                    overlay.style.transition = '';
                    victoryText.style.transition = '';
                }, 800);
            }, 3500);
        }
    </script>

    <!-- Add celebration elements after the modal -->
    <div class="celebration-overlay" id="celebration-overlay"></div>
    <div class="victory-text" id="victory-text">VICTORY!</div>
</body>
</html>
